<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0a0a0f;
    --surface:   #111118;
    --border:    #1e1e2e;
    --border2:   #2a2a3e;
    --accent:    #7c6af7;
    --accent2:   #a78bfa;
    --user-bg:   #16162a;
    --bot-bg:    #111118;
    --text:      #e2e2f0;
    --muted:     #6b6b8a;
    --success:   #34d399;
    --font-head: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
  }

  html, body { height: 100%; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 14px;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* ── NOISE OVERLAY ─────────────────────────────── */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* ── HEADER ────────────────────────────────────── */
  header {
    position: relative; z-index: 10;
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 28px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }

  .header-left { display: flex; align-items: center; gap: 14px; }

  .logo-mark {
    width: 36px; height: 36px;
    background: var(--accent);
    border-radius: 10px;
    display: grid; place-items: center;
    font-family: var(--font-head);
    font-weight: 800;
    font-size: 16px;
    color: #fff;
    box-shadow: 0 0 20px rgba(124,106,247,0.4);
  }

  .header-title {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: 17px;
    letter-spacing: -0.3px;
  }

  .header-sub {
    font-size: 11px;
    color: var(--muted);
    font-family: var(--font-mono);
    margin-top: 1px;
  }

  .status-dot {
    display: flex; align-items: center; gap: 7px;
    font-size: 11px; color: var(--muted);
  }
  .status-dot::before {
    content: '';
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--success);
    box-shadow: 0 0 8px var(--success);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; }
    50%      { opacity: 0.4; }
  }

  .btn-reset {
    background: none;
    border: 1px solid var(--border2);
    color: var(--muted);
    padding: 6px 14px;
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }
  .btn-reset:hover { border-color: var(--accent); color: var(--accent2); }

  /* ── MESSAGES AREA ─────────────────────────────── */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 28px 0;
    scroll-behavior: smooth;
    position: relative; z-index: 1;
  }

  #messages::-webkit-scrollbar { width: 4px; }
  #messages::-webkit-scrollbar-track { background: transparent; }
  #messages::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  .msg-row {
    display: flex;
    padding: 6px 28px;
    gap: 14px;
    animation: fadeUp 0.3s ease forwards;
    opacity: 0;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .msg-row.user { flex-direction: row-reverse; }

  .avatar {
    width: 30px; height: 30px;
    border-radius: 8px;
    display: grid; place-items: center;
    font-size: 13px;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .avatar.bot {
    background: linear-gradient(135deg, var(--accent), #5b4bd9);
    color: #fff;
    font-family: var(--font-head);
    font-weight: 700;
  }
  .avatar.user {
    background: var(--border2);
    color: var(--muted);
  }

  .bubble {
    max-width: min(680px, 75vw);
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.65;
    font-size: 13.5px;
  }

  .msg-row.bot .bubble {
    background: var(--bot-bg);
    border: 1px solid var(--border);
    border-top-left-radius: 3px;
    color: var(--text);
  }

  .msg-row.user .bubble {
    background: var(--user-bg);
    border: 1px solid var(--border2);
    border-top-right-radius: 3px;
    color: var(--text);
  }

  /* markdown inside bubble */
  .bubble p   { margin-bottom: 8px; }
  .bubble p:last-child { margin-bottom: 0; }
  .bubble strong { color: var(--accent2); font-weight: 600; }
  .bubble em     { color: #c4b5fd; font-style: italic; }
  .bubble code {
    background: #1a1a2e;
    border: 1px solid var(--border2);
    border-radius: 4px;
    padding: 1px 6px;
    font-family: var(--font-mono);
    font-size: 12px;
    color: #a78bfa;
  }
  .bubble pre {
    background: #0d0d1a;
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 14px;
    margin: 10px 0;
    overflow-x: auto;
  }
  .bubble pre code {
    background: none; border: none; padding: 0;
    font-size: 12px; color: #c4b5fd;
  }
  .bubble ul, .bubble ol { padding-left: 20px; margin: 6px 0; }
  .bubble li { margin-bottom: 4px; }

  /* streaming cursor blink */
  .cursor {
    display: inline-block;
    width: 2px; height: 14px;
    background: var(--accent2);
    margin-left: 2px;
    vertical-align: middle;
    animation: blink 0.8s step-end infinite;
  }
  @keyframes blink {
    0%,100% { opacity: 1; }
    50%      { opacity: 0; }
  }

  /* ── TYPING INDICATOR ──────────────────────────── */
  .typing-dots {
    display: flex; gap: 5px; align-items: center;
    padding: 4px 2px;
  }
  .typing-dots span {
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: bounce 1.2s ease-in-out infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%,80%,100% { transform: translateY(0);   opacity: 0.4; }
    40%          { transform: translateY(-5px); opacity: 1;   }
  }

  /* ── WELCOME SCREEN ────────────────────────────── */
  #welcome {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    height: 100%; gap: 14px;
    text-align: center; padding: 40px;
  }
  .welcome-icon {
    width: 64px; height: 64px;
    background: linear-gradient(135deg, var(--accent), #5b4bd9);
    border-radius: 18px;
    display: grid; place-items: center;
    font-size: 28px;
    box-shadow: 0 0 40px rgba(124,106,247,0.25);
    margin-bottom: 8px;
  }
  .welcome-title {
    font-family: var(--font-head);
    font-size: 26px; font-weight: 800;
    letter-spacing: -0.5px;
  }
  .welcome-sub { color: var(--muted); font-size: 13px; max-width: 340px; line-height: 1.6; }

  .chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
  .chip {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 20px;
    padding: 7px 16px;
    font-family: var(--font-mono);
    font-size: 12px; color: var(--muted);
    cursor: pointer; transition: all 0.2s;
  }
  .chip:hover { border-color: var(--accent); color: var(--accent2); transform: translateY(-1px); }

  /* ── INPUT BAR ─────────────────────────────────── */
  footer {
    position: relative; z-index: 10;
    padding: 16px 28px 20px;
    border-top: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }

  .input-wrap {
    display: flex; align-items: flex-end; gap: 10px;
    background: var(--bg);
    border: 1px solid var(--border2);
    border-radius: 12px;
    padding: 10px 10px 10px 16px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .input-wrap:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124,106,247,0.12);
  }

  #user-input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-family: var(--font-mono); font-size: 13.5px;
    resize: none; min-height: 22px; max-height: 120px;
    line-height: 1.5;
  }
  #user-input::placeholder { color: var(--muted); }

  #send-btn {
    width: 34px; height: 34px; flex-shrink: 0;
    background: var(--accent);
    border: none; border-radius: 8px;
    color: #fff; cursor: pointer;
    display: grid; place-items: center;
    transition: all 0.2s;
  }
  #send-btn:hover:not(:disabled) {
    background: var(--accent2);
    transform: scale(1.05);
    box-shadow: 0 0 16px rgba(124,106,247,0.4);
  }
  #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  #send-btn svg { width: 16px; height: 16px; }

  /* stop button style */
  #send-btn.stop { background: #5a2020; }
  #send-btn.stop:hover:not(:disabled) { background: #7a2020; box-shadow: none; }

  .footer-hint {
    text-align: center; color: var(--muted);
    font-size: 10.5px; margin-top: 10px; letter-spacing: 0.2px;
  }

  /* ── ERROR TOAST ────────────────────────────────── */
  #toast {
    position: fixed; top: 20px; right: 20px;
    background: #2d1515; border: 1px solid #5a2020;
    color: #f87171; padding: 12px 18px; border-radius: 8px;
    font-size: 12px; z-index: 999;
    transform: translateY(-80px); opacity: 0;
    transition: all 0.3s; pointer-events: none;
  }
  #toast.show { transform: translateY(0); opacity: 1; }
</style>
</head>
<body>

<div id="toast"></div>

<!-- HEADER -->
<header>
  <div class="header-left">
    <div class="logo-mark">AI</div>
    <div>
      <div class="header-title">AI Assistant</div>
      <div class="header-sub">powered by LM Studio</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:20px;">
    <div class="status-dot">online</div>
    <button class="btn-reset" onclick="resetChat()">↺ reset</button>
  </div>
</header>

<!-- MESSAGES -->
<div id="messages">
  <div id="welcome">
    <div class="welcome-icon">✦</div>
    <div class="welcome-title">How can I help?</div>
    <div class="welcome-sub">Ask me anything — I remember our conversation as we go.</div>
    <div class="chips">
      <div class="chip" onclick="sendChip(this)">Explain something complex</div>
      <div class="chip" onclick="sendChip(this)">Write code for me</div>
      <div class="chip" onclick="sendChip(this)">Summarise a topic</div>
      <div class="chip" onclick="sendChip(this)">Help me brainstorm</div>
    </div>
  </div>
</div>

<!-- INPUT -->
<footer>
  <div class="input-wrap">
    <textarea id="user-input" rows="1" placeholder="Type a message…"></textarea>
    <button id="send-btn" onclick="handleBtn()" title="Send">
      <!-- Send icon -->
      <svg id="icon-send" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"
           stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
      <!-- Stop icon (hidden by default) -->
      <svg id="icon-stop" viewBox="0 0 24 24" fill="currentColor" style="display:none">
        <rect x="5" y="5" width="14" height="14" rx="2"/>
      </svg>
    </button>
  </div>
  <div class="footer-hint">Enter to send · Shift+Enter for new line</div>
</footer>

<script>
// ── Simple markdown renderer ──────────────────────────────────────────────────
function renderMarkdown(text) {
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^### (.+)$/gm, '<strong>$1</strong>')
    .replace(/^## (.+)$/gm,  '<strong>$1</strong>')
    .replace(/^# (.+)$/gm,   '<strong>$1</strong>')
    .replace(/^\* (.+)$/gm,  '<li>$1</li>')
    .replace(/^- (.+)$/gm,   '<li>$1</li>')
    .replace(/^\d+\. (.+)$/gm,'<li>$1</li>')
    .replace(/(<li>[\s\S]+?<\/li>)/g, '<ul>$1</ul>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^(?!<)(.+)$/gm, '<p>$1</p>')
    .replace(/<p><\/p>/g, '');
}

// ── State ─────────────────────────────────────────────────────────────────────
const SESSION_ID = 'session_' + Math.random().toString(36).slice(2);
let isLoading    = false;
let abortCtrl    = null;   // AbortController for the active stream

// ── DOM refs ──────────────────────────────────────────────────────────────────
const messagesEl = document.getElementById('messages');
const inputEl    = document.getElementById('user-input');
const sendBtn    = document.getElementById('send-btn');
const iconSend   = document.getElementById('icon-send');
const iconStop   = document.getElementById('icon-stop');
const welcomeEl  = document.getElementById('welcome');
const toastEl    = document.getElementById('toast');

// ── Auto-resize textarea ──────────────────────────────────────────────────────
inputEl.addEventListener('input', () => {
  inputEl.style.height = 'auto';
  inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
});

inputEl.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleBtn(); }
});

// ── Button toggles between Send and Stop ─────────────────────────────────────
function setLoadingState(loading) {
  isLoading = loading;
  if (loading) {
    sendBtn.classList.add('stop');
    iconSend.style.display = 'none';
    iconStop.style.display = '';
    sendBtn.title = 'Stop';
  } else {
    sendBtn.classList.remove('stop');
    iconSend.style.display = '';
    iconStop.style.display = 'none';
    sendBtn.title = 'Send';
    sendBtn.disabled = false;
  }
}

function handleBtn() {
  if (isLoading) {
    // Stop the current stream
    if (abortCtrl) abortCtrl.abort();
  } else {
    sendMessage();
  }
}

// ── Append message bubble ─────────────────────────────────────────────────────
function appendMessage(role, html, isTyping = false) {
  const welcome = document.getElementById('welcome');
  if (welcome) welcome.remove();

  const row = document.createElement('div');
  row.className = `msg-row ${role}`;

  const avatar = document.createElement('div');
  avatar.className = `avatar ${role}`;
  avatar.textContent = role === 'bot' ? 'AI' : '→';

  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  if (isTyping) {
    bubble.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
  } else {
    bubble.innerHTML = html;
  }

  row.appendChild(avatar);
  row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return bubble;
}

// ── Send message (streaming) ──────────────────────────────────────────────────
async function sendMessage() {
  const text = inputEl.value.trim();
  if (!text || isLoading) return;

  setLoadingState(true);
  inputEl.value = '';
  inputEl.style.height = 'auto';

  // User bubble
  appendMessage('user', renderMarkdown(text));

  // Bot bubble — starts with typing dots, then fills with streamed tokens
  const botBubble = appendMessage('bot', '', true);
  let   rawTokens = '';    // accumulates plain text tokens
  let   started   = false; // has first token arrived?

  abortCtrl = new AbortController();

  try {
    const res = await fetch('/assistant', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, session_id: SESSION_ID, stream: true }),
      signal: abortCtrl.signal,
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({ error: 'Request failed' }));
      throw new Error(err.error || 'Request failed');
    }

    const reader  = res.body.getReader();
    const decoder = new TextDecoder();
    let   buffer  = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });

      // Process all complete SSE lines in the buffer
      const lines = buffer.split('\n');
      buffer = lines.pop(); // keep the incomplete last chunk

      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed.startsWith('data:')) continue;

        const dataStr = trimmed.slice(5).trim();
        if (!dataStr) continue;

        let parsed;
        try { parsed = JSON.parse(dataStr); }
        catch { continue; }

        if (parsed.error) {
          throw new Error(parsed.error);
        }

        if (parsed.token) {
          if (!started) {
            // Replace typing dots with empty content + cursor on first token
            botBubble.innerHTML = '<span class="cursor"></span>';
            started = true;
          }
          rawTokens += parsed.token;

          // Re-render markdown and re-append cursor while streaming
          botBubble.innerHTML = renderMarkdown(rawTokens) + '<span class="cursor"></span>';
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        if (parsed.done) {
          // Final render — remove cursor
          botBubble.innerHTML = renderMarkdown(rawTokens);
        }
      }
    }

    // Ensure cursor is gone at the end
    if (started) botBubble.innerHTML = renderMarkdown(rawTokens);

  } catch (err) {
    if (err.name === 'AbortError') {
      // User stopped the stream — finalise what we have
      if (rawTokens) {
        botBubble.innerHTML = renderMarkdown(rawTokens) +
          '<br><span style="color:var(--muted);font-size:11px">— stopped —</span>';
      } else {
        botBubble.innerHTML = '<span style="color:var(--muted)">Stopped.</span>';
      }
    } else {
      botBubble.innerHTML = `<span style="color:#f87171">⚠ ${err.message}</span>`;
      showToast(err.message);
    }
  } finally {
    setLoadingState(false);
    abortCtrl = null;
    inputEl.focus();
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
}

// ── Chip shortcut ─────────────────────────────────────────────────────────────
function sendChip(el) {
  inputEl.value = el.textContent;
  sendMessage();
}

// ── Reset ─────────────────────────────────────────────────────────────────────
async function resetChat() {
  if (abortCtrl) abortCtrl.abort();
  try {
    await fetch('/assistant/reset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: SESSION_ID }),
    });
  } catch (_) {}

  messagesEl.innerHTML = `
    <div id="welcome" style="display:flex;flex-direction:column;align-items:center;
         justify-content:center;height:100%;gap:14px;text-align:center;padding:40px;">
      <div class="welcome-icon" style="width:64px;height:64px;background:linear-gradient(135deg,var(--accent),#5b4bd9);
           border-radius:18px;display:grid;place-items:center;font-size:28px;
           box-shadow:0 0 40px rgba(124,106,247,.25);margin-bottom:8px;">✦</div>
      <div class="welcome-title" style="font-family:var(--font-head);font-size:26px;font-weight:800;letter-spacing:-.5px;">
        Conversation reset</div>
      <div style="color:var(--muted);font-size:13px;">Start a new topic whenever you're ready.</div>
    </div>`;
}

// ── Toast ─────────────────────────────────────────────────────────────────────
function showToast(msg) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(() => toastEl.classList.remove('show'), 3500);
}

inputEl.focus();
</script>
</body>
</html>